esphome:
  name: atom-s3-bluetooth-proxy
  friendly_name: Atom S3 Bluetooth Proxy
  on_boot:
    priority: -100
    then:
      - output.turn_on: backlight_gpio

esp32:
  board: m5stack-atoms3
  framework:
    type: esp-idf

logger:
  level: INFO

api:
  encryption:
    # Generated by ESPHome; stored in secrets.yaml
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "Atom-S3-Bluetooth-Proxy"
    password: !secret ap_password

captive_portal:

font:
  - file: "gfonts://Roboto"
    id: font_small
    size: 16
  - file: "gfonts://Roboto"
    id: font_large
    size: 24

esp32_ble_tracker:
  scan_parameters:
    active: true

bluetooth_proxy:
  active: true

spi:
  clk_pin: GPIO17
  mosi_pin: GPIO21

display:
  - platform: st7789v
    id: display_tft
    model: CUSTOM
    width: 128
    height: 128
    offset_width: 1
    offset_height: 2

    # Optional display rotation (uncomment if mounting differently)
    # If changed, text alignment and offsets may need adjustment.
    # rotation: 180    

    cs_pin: GPIO15
    dc_pin: GPIO33
    reset_pin: GPIO34
    update_interval: never
    lambda: |-
      it.fill(Color(0, 0, 0));

      it.printf(64, 10, id(font_large),
                Color(255, 255, 255),
                TextAlign::TOP_CENTER,
                "BT Proxy");

      it.printf(64, 45, id(font_small),
                id(esphome_status).state ? Color(0, 255, 0) : Color(255, 0, 0),
                TextAlign::TOP_CENTER,
                "ESPHome: %s",
                id(esphome_status).state ? "ONLINE" : "OFFLINE");

      float rssi = id(wifi_rssi).state;
      Color signal_color =
          (rssi > -60) ? Color(0, 255, 0) :
          (rssi > -70) ? Color(255, 165, 0) :
                         Color(255, 0, 0);

      it.printf(64, 80, id(font_small),
                signal_color,
                TextAlign::TOP_CENTER,
                "Signal: %.0f dBm", rssi);

sensor:
  - platform: wifi_signal
    name: "Atom S3 WiFi RSSI"
    id: wifi_rssi
    update_interval: 60s
    on_value:
      then:
        - component.update: display_tft

binary_sensor:
  # Tracks whether ESPHome is connected to Home Assistant
  - platform: status
    id: esphome_status
    on_state:
      then:
        - component.update: display_tft

output:
  - platform: gpio
    pin: GPIO16
    id: backlight_gpio
